<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–Ω–∞–ª–∏–∑ –ø–æ–¥–∞—Ä–∫–æ–≤ Telegram</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

    <body>
        <button id="refreshButton" class="refresh-btn" type="button">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <div id="status"></div>

    <div class="settings">
        <label for="exchangeRate">–ö—É—Ä—Å 1 TON –≤ –∑–≤—ë–∑–¥–∞—Ö:</label>
        <input type="number" id="exchangeRate" value="1" step="any">
        <label for="currencySelect">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ü–µ–Ω—ã –≤:</label>
        <select id="currencySelect">
            <option value="ton">TON</option>
            <option value="stars">–ó–≤–µ–∑–¥—ã</option>
        </select>
    </div>
    <div class="filters">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–¥–∞—Ä–∫—É –∏–ª–∏ –º–æ–¥–µ–ª–∏">
        <label>–¶–µ–Ω–∞ –æ—Ç: <input type="number" id="minPrice" step="any"></label>
        <label>–¥–æ: <input type="number" id="maxPrice" step="any"></label>
        <label>–ú–∏–Ω. % –≤—ã–≥–æ–¥—ã: <input type="number" id="minDelta" step="any"></label>
    </div>
      <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏ Telegram</h2>
    <table>
        <thead>
            <tr>
                <th>üéÅ –ü–æ–¥–∞—Ä–æ–∫ Telegram</th>
                <th id="thermosHeader">üí∞ –¶–µ–Ω–∞ –Ω–∞ Thermos (TON)</th>
                <th id="tgmarketHeader">üìà –¶–µ–Ω–∞ –Ω–∞ TG Market (‚≠ê)</th>
                <th>üìä –†–∞–∑–Ω–∏—Ü–∞ (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for gift in gifts %}
            <tr data-ton="{{ gift.thermos_price }}" data-stars="{{ gift.tgmarket_price }}">
                <td>{{ gift.tg_name }}</td>
                <td class="thermos-price"></td>
                <td class="tgmarket-price"></td>
                <td class="delta"></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
      <script>
          async function updateData() {
              const statusEl = document.getElementById('status');
              const btn = document.getElementById('refreshButton');
              statusEl.textContent = '–ò–¥—ë—Ç —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...';
              btn.disabled = true;
              try {
                  const resp = await fetch('/update', { method: 'POST' });
                  if (!resp.ok) throw new Error('Network response was not ok');
                  window.location.reload();
              } catch (err) {
                  statusEl.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö';
                  btn.disabled = false;
              }
          }

          function updatePrices() {
            const rateInput = document.getElementById('exchangeRate');
            const select = document.getElementById('currencySelect');
            const rate = parseFloat(rateInput.value) || 1;
            const currency = select.value;

            document.getElementById('thermosHeader').textContent = `üí∞ –¶–µ–Ω–∞ –Ω–∞ Thermos (${currency === 'ton' ? 'TON' : '‚≠ê'})`;
            document.getElementById('tgmarketHeader').textContent = `üìà –¶–µ–Ω–∞ –Ω–∞ TG Market (${currency === 'ton' ? 'TON' : '‚≠ê'})`;

            document.querySelectorAll('tbody tr').forEach(row => {
                const ton = parseFloat(row.dataset.ton);
                const stars = parseFloat(row.dataset.stars);
                let thermosPrice, tgPrice;

                if (currency === 'ton') {
                    thermosPrice = ton;
                    tgPrice = stars / rate;
                } else {
                    thermosPrice = ton * rate;
                    tgPrice = stars;
                }

                row.querySelector('.thermos-price').textContent = thermosPrice.toFixed(2);
                row.querySelector('.tgmarket-price').textContent = tgPrice.toFixed(2);

                const deltaCell = row.querySelector('.delta');
                if (thermosPrice) {
                    const delta = ((tgPrice - thermosPrice) / thermosPrice * 100).toFixed(2);
                    deltaCell.textContent = `${delta}%`;
                    deltaCell.className = 'delta ' + (delta >= 0 ? 'positive' : 'negative');
                } else {
                    deltaCell.textContent = '-';
                    deltaCell.className = 'delta';
                }
            });
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const minPrice = parseFloat(document.getElementById('minPrice').value);
            const maxPrice = parseFloat(document.getElementById('maxPrice').value);
            const minDelta = parseFloat(document.getElementById('minDelta').value);

            document.querySelectorAll('tbody tr').forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const price = parseFloat(row.querySelector('.thermos-price').textContent) || 0;
                const delta = parseFloat(row.querySelector('.delta').textContent) || 0;

                const matchSearch = name.includes(search);
                const matchPrice = (isNaN(minPrice) || price >= minPrice) && (isNaN(maxPrice) || price <= maxPrice);
                const matchDelta = isNaN(minDelta) || delta >= minDelta;

                row.style.display = (matchSearch && matchPrice && matchDelta) ? '' : 'none';
            });
        }

          document.getElementById('refreshButton').addEventListener('click', updateData);
          document.getElementById('exchangeRate').addEventListener('input', updatePrices);
          document.getElementById('currencySelect').addEventListener('change', updatePrices);
          document.getElementById('searchInput').addEventListener('input', applyFilters);
          document.getElementById('minPrice').addEventListener('input', applyFilters);
          document.getElementById('maxPrice').addEventListener('input', applyFilters);
          document.getElementById('minDelta').addEventListener('input', applyFilters);
          window.addEventListener('DOMContentLoaded', updatePrices);
      </script>
    </body>
    </html>

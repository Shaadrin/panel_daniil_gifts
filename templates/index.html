<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–Ω–∞–ª–∏–∑ –ø–æ–¥–∞—Ä–∫–æ–≤ Telegram</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <img id="loadingGif" src="" alt="loading" class="loading-gif">
        <div class="loading-text">–ò–¥—ë—Ç —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö. –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç 2 –º–∏–Ω—É—Ç—ã.</div>
    </div>
    <div id="mainContent">
        <button id="refreshButton" class="refresh-btn" type="button">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <div id="status"></div>

        <div class="settings">
            <label for="exchangeRate">–ö—É—Ä—Å 1 TON –≤ –∑–≤—ë–∑–¥–∞—Ö:</label>
            <input type="number" id="exchangeRate" step="any">
            <label for="currencySelect">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ü–µ–Ω—ã –≤:</label>
            <select id="currencySelect">
                <option value="ton">TON</option>
                <option value="stars">–ó–≤–µ–∑–¥—ã</option>
            </select>
        </div>
        <div id="noRateMessage" class="no-rate-message" style="display:none">—É–∫–∞–∂–∏—Ç–µ –∫—É—Ä—Å ton/stars</div>
        <div class="filters">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–¥–∞—Ä–∫—É –∏–ª–∏ –º–æ–¥–µ–ª–∏">
            <div class="filter-group">
                <label for="minPrice">–¶–µ–Ω–∞ –æ—Ç:</label>
                <input type="number" id="minPrice" step="any">
            </div>
            <div class="filter-group">
                <label for="maxPrice">–¥–æ:</label>
                <input type="number" id="maxPrice" step="any">
            </div>
            <div class="filter-group">
                <label for="minDelta">–ú–∏–Ω. % –≤—ã–≥–æ–¥—ã:</label>
                <input type="number" id="minDelta" step="any">
            </div>
        </div>
        <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏ Telegram</h2>
        <table>
            <thead>
                <tr>
                    <th>üéÅ –ü–æ–¥–∞—Ä–æ–∫ Telegram</th>
                    <th id="thermosHeader">üí∞ –¶–µ–Ω–∞ –Ω–∞ Thermos (TON)</th>
                    <th id="tgmarketHeader">üìà –¶–µ–Ω–∞ –Ω–∞ TG Market (‚≠ê)</th>
                    <th>üìä –†–∞–∑–Ω–∏—Ü–∞ (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for gift in gifts %}
                <tr data-ton="{{ gift.thermos_price }}" data-stars="{{ gift.tgmarket_price }}">
                    <td>{{ gift.tg_name }}</td>
                    <td class="thermos-price"></td>
                    <td class="tgmarket-price"></td>
                    <td class="delta"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    <script>
        const gifs = {{ gif_files|safe }};
        async function updateData() {
            const btn = document.getElementById('refreshButton');
            const overlay = document.getElementById('loadingOverlay');
            const content = document.getElementById('mainContent');
            const gifElem = document.getElementById('loadingGif');
            if (Array.isArray(gifs) && gifs.length > 0) {
                gifElem.src = gifs[Math.floor(Math.random() * gifs.length)];
            }
            overlay.style.display = 'flex';
            content.style.display = 'none';
            btn.disabled = true;
            try {
                const resp = await fetch('/update', { method: 'POST' });
                if (!resp.ok) throw new Error('Network response was not ok');
                window.location.reload();
            } catch (err) {
                overlay.style.display = 'none';
                content.style.display = '';
                btn.disabled = false;
            }
        }

        function updatePrices() {
            const rateInput = document.getElementById('exchangeRate');
            const select = document.getElementById('currencySelect');
            const rate = parseFloat(rateInput.value);
            const currency = select.value;
            const table = document.querySelector('table');
            const filters = document.querySelector('.filters');
            const msg = document.getElementById('noRateMessage');

            if (isNaN(rate) || rate <= 0) {
                table.style.display = 'none';
                filters.style.display = 'none';
                msg.style.display = 'block';
                return;
            } else {
                table.style.display = '';
                filters.style.display = '';
                msg.style.display = 'none';
            }
            document.getElementById('thermosHeader').textContent = `üí∞ –¶–µ–Ω–∞ –Ω–∞ Thermos (${currency === 'ton' ? 'TON' : '‚≠ê'})`;
            document.getElementById('tgmarketHeader').textContent = `üìà –¶–µ–Ω–∞ –Ω–∞ TG Market (${currency === 'ton' ? 'TON' : '‚≠ê'})`;

            document.querySelectorAll('tbody tr').forEach(row => {
                const ton = parseFloat(row.dataset.ton);
                const stars = parseFloat(row.dataset.stars);
                let thermosPrice, tgPrice;

                if (currency === 'ton') {
                    thermosPrice = ton;
                    tgPrice = stars / rate;
                } else {
                    thermosPrice = ton * rate;
                    tgPrice = stars;
                }

                row.querySelector('.thermos-price').textContent = thermosPrice.toFixed(2);
                row.querySelector('.tgmarket-price').textContent = tgPrice.toFixed(2);

                const deltaCell = row.querySelector('.delta');
                if (thermosPrice) {
                    const delta = ((tgPrice - thermosPrice) / thermosPrice * 100).toFixed(2);
                    deltaCell.textContent = `${delta}%`;
                    deltaCell.className = 'delta ' + (delta >= 0 ? 'positive' : 'negative');
                } else {
                    deltaCell.textContent = '-';
                    deltaCell.className = 'delta';
                }
            });
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const minPrice = parseFloat(document.getElementById('minPrice').value);
            const maxPrice = parseFloat(document.getElementById('maxPrice').value);
            const minDelta = parseFloat(document.getElementById('minDelta').value);

            document.querySelectorAll('tbody tr').forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const price = parseFloat(row.querySelector('.thermos-price').textContent) || 0;
                const delta = parseFloat(row.querySelector('.delta').textContent) || 0;

                const matchSearch = name.includes(search);
                const matchPrice = (isNaN(minPrice) || price >= minPrice) && (isNaN(maxPrice) || price <= maxPrice);
                const matchDelta = isNaN(minDelta) || delta >= minDelta;

                row.style.display = (matchSearch && matchPrice && matchDelta) ? '' : 'none';
            });
        }

        document.getElementById('refreshButton').addEventListener('click', updateData);
        document.getElementById('exchangeRate').addEventListener('input', updatePrices);
        document.getElementById('currencySelect').addEventListener('change', updatePrices);
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('minPrice').addEventListener('input', applyFilters);
        document.getElementById('maxPrice').addEventListener('input', applyFilters);
        document.getElementById('minDelta').addEventListener('input', applyFilters);
        window.addEventListener('DOMContentLoaded', updatePrices);
    </script>
</body>
</html>